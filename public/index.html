<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title></title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      body {
        margin: 0;
      }
      canvas {
        display: block;
        width: 100%;
        height: 100%;
      }
      #log {
        position: absolute;
      }
    </style>
  </head>
  <body>
    <div id="log"></div>
    <script type="module">
      
      import { Client } from './js/Client.js';
      
      // Canvas
      
      const canvas = document.createElement( 'canvas' );
      canvas.width = window.innerWidth * window.devicePixelRatio;
      canvas.height = window.innerHeight * window.devicePixelRatio;
      canvas.style.width = window.innerWidth + 'px';
      canvas.style.height = window.innerHeight + 'px';
      document.body.appendChild( canvas );
      
      const context = canvas.getContext( '2d' );
      
      // WebSockets
      
      const ws = new WebSocket( 'wss://' + window.location.hostname );
      ws.binaryType = 'arraybuffer';

      ws.addEventListener( 'open', function ( event ) {

        log.textContent = 'connected';

      } );

      ws.addEventListener( 'close', function ( event ) {

        log.textContent = 'disconnected';

      } );

      ws.addEventListener( 'message', function ( event ) {

        let data = new DataView( event.data );
        
        context.beginPath();
        
        let cx = data.getUint16( 0 );
        let cy = data.getUint16( 2 );
        
        context.moveTo( cx, cy );
        
        for ( var i = 0; i <= 60; i += 2 ) {
          cx += data.getInt8( 4 + i + 0 );
          cy += data.getInt8( 4 + i + 1 );
          context.lineTo( cx, cy );

        }
        
        context.stroke();

      } );
      
      const client = new Client();
      
      document.addEventListener( 'mousemove', function ( event ) {

        const x = parseInt( event.pageX * window.devicePixelRatio );
        const y = parseInt( event.pageY * window.devicePixelRatio );
        client.moveTo( x, y );
        
        if ( client.isFull() ) {

          ws.send( client.buffer() );
          client.reset();

        } 

      } );
      
    </script>
  </body>
</html>

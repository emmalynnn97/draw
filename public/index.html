<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Multiuser Sketchpad 2020</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      html {
        touch-action: none;
      }
      body {
        background: #f0f0f0;
        font-size: 12px;
        font-family: sans-serif;
        margin: 0;
      }
      #canvas {
        display: block;
        width: 100%;
        height: 100%;
        cursor: crosshair;
      }
      #cursors {
        position: absolute;
        width: 100%;
        height: 100%;
        overflow: hidden;
        pointer-events: none;
      }
      #status {
        position: absolute;
        left: 16px;
        top: 10px;
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <div id="status"></div>
    <div id="cursors"></div>
    <script type="module">
      
      /**
       * @author mrdoob / http://mrdoob.com/
       */
      
      import { Client } from './js/Client.js';
      import { Recorder } from './js/Recorder.js';
      
      // const debug = window.location.search === '?debug';
      
      // Canvas
      
      const canvas = document.createElement( 'canvas' );
      canvas.id = 'canvas';
      canvas.width = window.innerWidth * window.devicePixelRatio;
      canvas.height = window.innerHeight * window.devicePixelRatio;
      document.body.appendChild( canvas );
      
      const context = canvas.getContext( '2d' );
      context.lineWidth = 0.5 * window.devicePixelRatio;
      
      window.addEventListener( 'resize', function () {
        
        canvas.width = window.innerWidth * window.devicePixelRatio;
        canvas.height = window.innerHeight * window.devicePixelRatio;   
        
        context.lineWidth = 0.5 * window.devicePixelRatio;
        
      } );

      //
      
      let clients = {};
      let recorder = null;
      
      // WebSockets
            
      const ws = new WebSocket( 'wss://' + window.location.hostname );
      ws.binaryType = 'arraybuffer';

      ws.addEventListener( 'open', function ( event ) {

        recorder = new Recorder( context );

        canvas.addEventListener( 'pointermove', onPointerMove );
        canvas.addEventListener( 'pointerdown', onPointerDown );
        canvas.addEventListener( 'pointerup', onPointerUp );

        document.getElementById( 'status' ).textContent = 'ðŸŸ¢';    

      } );

      ws.addEventListener( 'close', function ( event ) {

        recorder = null;

        canvas.removeEventListener( 'pointermove', onPointerMove );
        canvas.removeEventListener( 'pointerdown', onPointerDown );
        canvas.removeEventListener( 'pointerup', onPointerUp );
        
        document.getElementById( 'status' ).textContent = 'ðŸ”´';

      } );

      ws.addEventListener( 'message', function ( event ) {

        let dataview = new DataView( event.data );
        let id = dataview.getUint8( 0 );
      
        if ( clients[ id ] === undefined ) {
          
          let container = document.getElementById( 'cursors' );
          clients[ id ] = new Client( context, container );
          
        }
        
        /*
        if ( debug === true ) {
          
          console.log(
            dataview.getUint8( 0 ),
            dataview.getUint8( 1 )
          );
          
        }
        */
        
        clients[ id ].execute( dataview );

      } );
      
      // Recorder

      canvas.addEventListener( 'touchstart', function ( event ) {
        
        event.preventDefault();
              
      } );
      
      let ptime = 0;
      
      function onPointerMove( event ) {
        
        event.preventDefault();

        if ( recorder ) {

          // Throttle to 60Hz

          const throttle = ( 1 / 60 ) * 100;
          const time = event.timeStamp;

          if ( time < ( ptime + throttle ) ) return;

          ptime = time;

          //

          const x = parseInt( event.pageX * window.devicePixelRatio );
          const y = parseInt( event.pageY * window.devicePixelRatio );

          ws.send( recorder.move( x, y ) );
          
        }

      }
      
      function onPointerDown( even ) {

        const x = parseInt( event.pageX * window.devicePixelRatio );
        const y = parseInt( event.pageY * window.devicePixelRatio );

        ws.send( recorder.down( x, y ) );
        
      }
      
      function onPointerUp( event ) {
        
        ws.send( recorder.up() );
        
      }
      
    </script>
  </body>
</html>

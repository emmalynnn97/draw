<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Multiuser Sketchpad</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="icon" type="image/png" sizes="512x512" href="https://cdn.glitch.com/2eb3583a-fedf-4a97-8bd7-57628dd21473%2Fmultisketch-icon.png?v=1587113151672">
    <link rel="apple-touch-icon" type="image/png" sizes="512x512" href="https://cdn.glitch.com/2eb3583a-fedf-4a97-8bd7-57628dd21473%2Fmultisketch-icon.png?v=1587113151672">
    <link type="text/css" rel="stylesheet" href="./css/main.css">
  </head>
  <body>
    <canvas id="canvas"></canvas>
    <div id="menu">
      <span class="submenu">
        <span id="status">üü°</span>&nbsp; SOCKET
      </span>
      <span class="submenu">
        <span id="colors">
          <span>‚ö´Ô∏è</span>
          <span>‚ö™Ô∏è</span>
        </span>&nbsp;
        <a href="https://multiuser-sketchpad-colors.glitch.me/">‚ûï</a>
      </span>
      <span class="submenu info"><a href="https://twitter.com/mrdoob" target="_blank">üí¨</a></span>
    </div>
    <div id="cursors"></div>
    <script type="module">
      
      /**
       * @author mrdoob / http://mrdoob.com/
       *
       * Source code:
       * https://glitch.com/edit/#!/multiuser-sketchpad
       */
      
      import { Painter } from './js/Painter.js';
      import { Recorder } from './js/Recorder.js';
      
      // const DEBUG = window.location.search === '?debug';
      
      // Canvas
      
      const scale = 2;
      
      const canvas = document.getElementById( 'canvas' );
      canvas.width = window.innerWidth * window.devicePixelRatio * scale;
      canvas.height = window.innerHeight * window.devicePixelRatio * scale;
      canvas.style.position = 'absolute';
      canvas.style.width = ( window.innerWidth * scale ) + 'px';
      canvas.style.height = ( window.innerHeight * scale ) + 'px';
      
      const context = canvas.getContext( '2d' );
      context.lineWidth = 0.7 * window.devicePixelRatio;
      context.fillStyle = '#eeeeee';
      context.fillRect( 0, 0, canvas.width, canvas.height );
      
      let position = { x: 0, y: 0 };
      
      canvas.addEventListener( 'wheel', function ( event ) {
        
        position.x -= event.deltaX;
        position.y -= event.deltaY;
        
        canvas.style.left = position.x + 'px';
        canvas.style.top = position.y + 'px';
        
      } );

      //
      
      let painters = {};
      let recorder = null;
      let isPointerDown = false;
      
      // WebSockets
            
      const ws = new WebSocket( 'wss://' + window.location.hostname );
      ws.binaryType = 'arraybuffer';

      ws.addEventListener( 'open', function ( event ) {

        recorder = new Recorder( context, ws );

        canvas.addEventListener( 'pointermove', onPointerMove );
        canvas.addEventListener( 'pointerdown', onPointerDown );
        canvas.addEventListener( 'pointerup', onPointerUp );

        document.getElementById( 'status' ).textContent = 'üü¢';       
              
        // Colors

        let colors = document.getElementById( 'colors' );

        for ( let i = 0; i < colors.children.length; i ++ ) {

          let child = colors.children[ i ];
          child.addEventListener( 'click', function ( event ) {

            recorder.color( i );

          } ); 
          
        }

      } );

      ws.addEventListener( 'close', function ( event ) {

        recorder = null;

        canvas.removeEventListener( 'pointermove', onPointerMove );
        canvas.removeEventListener( 'pointerdown', onPointerDown );
        canvas.removeEventListener( 'pointerup', onPointerUp );
        
        document.getElementById( 'status' ).textContent = 'üî¥';

      } );

      ws.addEventListener( 'message', function ( event ) {

        let dataview = new DataView( event.data );
        let id = dataview.getUint8( 0 );
      
        if ( painters[ id ] === undefined ) {
          
          let container = document.getElementById( 'cursors' );
          painters[ id ] = new Painter( context, container );
          
        }
        
        painters[ id ].execute( dataview );

      } );
      
      // It's 2020 and WebKit/iOS still needs this...

      canvas.addEventListener( 'touchstart', function ( event ) {
        
        event.preventDefault();
              
      } );
      
      // Recorder
      
      let ptime = 0;
      
      function onPointerMove( event ) {
        
        event.preventDefault();

        if ( isPointerDown ) {

          // Throttle to 30Hz

          const throttle = ( 1 / 30 ) * 1000;
          const time = event.timeStamp;

          if ( time < ( ptime + throttle ) ) return;

          ptime = time;

          //        

          const x = parseInt( event.pageX * window.devicePixelRatio );
          const y = parseInt( event.pageY * window.devicePixelRatio );

          recorder.move( x, y );

        }

      }
      
      function onPointerDown( even ) {
        
        isPointerDown = true;

        const x = parseInt( event.pageX * window.devicePixelRatio );
        const y = parseInt( event.pageY * window.devicePixelRatio );

        recorder.down( x, y );
        
      }
      
      function onPointerUp( event ) {
        
        isPointerDown = false;
        
        recorder.up();
        
      }
      
    </script>
  </body>
</html>

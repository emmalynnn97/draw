<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Multiuser Sketchpad 2020</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link type="text/css" rel="stylesheet" href="./css/main.css">
  </head>
  <body>
    <div id="menu">
      <span class="submenu">
        STATUS &nbsp;<span id="status">üü°</span> 
      </span>
      <span class="submenu">
        <a href="https://multiuser-sketchpad-colors.glitch.me/">‚úèÔ∏è</a> <span style="padding:0 8px">|</span> <span id="color">‚ö´Ô∏è</span>
      </span>
    </div>
    <div id="cursors"></div>
    <script type="module">
      
      /**
       * @author mrdoob / http://mrdoob.com/
       *
       * Source code:
       * https://glitch.com/edit/#!/multiuser-sketchpad
       */
      
      import { Painter } from './js/Painter.js';
      import { Recorder } from './js/Recorder.js';
      
      // const DEBUG = window.location.search === '?debug';

      let colorButton = document.getElementById( 'color' );
      
      // Canvas
      
      const canvas = document.createElement( 'canvas' );
      canvas.id = 'canvas';
      canvas.width = window.innerWidth * window.devicePixelRatio;
      canvas.height = window.innerHeight * window.devicePixelRatio;
      canvas.style.width = window.innerWidth + 'px';
      canvas.style.height = window.innerHeight + 'px';
      document.body.appendChild( canvas );
      
      const context = canvas.getContext( '2d' );
      context.lineWidth = 0.7 * window.devicePixelRatio;
      context.fillStyle = '#eeeeee';
      context.fillRect( 0, 0, canvas.width, canvas.height );

      //
      
      let painters = {};
      let recorder = null;
      let isPointerDown = false;
      
      // WebSockets
            
      const ws = new WebSocket( 'wss://' + window.location.hostname );
      ws.binaryType = 'arraybuffer';

      ws.addEventListener( 'open', function ( event ) {

        recorder = new Recorder( context );

        canvas.addEventListener( 'pointermove', onPointerMove );
        canvas.addEventListener( 'pointerdown', onPointerDown );
        canvas.addEventListener( 'pointerup', onPointerUp );
              
        colorButton.addEventListener( 'click', onColorClick );

        document.getElementById( 'status' ).textContent = 'üü¢';    

      } );

      ws.addEventListener( 'close', function ( event ) {

        recorder = null;

        canvas.removeEventListener( 'pointermove', onPointerMove );
        canvas.removeEventListener( 'pointerdown', onPointerDown );
        canvas.removeEventListener( 'pointerup', onPointerUp );
        
        document.getElementById( 'status' ).textContent = 'üî¥';

      } );

      ws.addEventListener( 'message', function ( event ) {

        let dataview = new DataView( event.data );
        let id = dataview.getUint8( 0 );
      
        if ( painters[ id ] === undefined ) {
          
          let container = document.getElementById( 'cursors' );
          painters[ id ] = new Painter( context, container );
          
        }
        
        painters[ id ].execute( dataview );

      } );
      
      // It's 2020 and WebKit/iOS still needs this...

      canvas.addEventListener( 'touchstart', function ( event ) {
        
        event.preventDefault();
              
      } );
      
      
      // Menu
      
      let color = 0;
      let colors = [ '‚ö´Ô∏è', '‚ö™Ô∏è' ];
      
      function onColorClick() {

        color = ( color + 1 ) % colors.length;
        colorButton.textContent = colors[ color ];
        
        recorder.color( color );

      }
      
      // Recorder
      
      let ptime = 0;
      
      function onPointerMove( event ) {
        
        event.preventDefault();

        if ( isPointerDown ) {

          // Throttle to 30Hz

          const throttle = ( 1 / 30 ) * 1000;
          const time = event.timeStamp;

          if ( time < ( ptime + throttle ) ) return;

          ptime = time;

          //        

          const x = parseInt( event.pageX * window.devicePixelRatio );
          const y = parseInt( event.pageY * window.devicePixelRatio );

          ws.send( recorder.move( x, y ) );

        }

      }
      
      function onPointerDown( even ) {
        
        isPointerDown = true;

        const x = parseInt( event.pageX * window.devicePixelRatio );
        const y = parseInt( event.pageY * window.devicePixelRatio );

        ws.send( recorder.down( x, y ) );
        
      }
      
      function onPointerUp( event ) {
        
        isPointerDown = false;
        
        ws.send( recorder.up() );
        
      }
      
    </script>
  </body>
</html>
